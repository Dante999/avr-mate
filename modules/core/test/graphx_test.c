#include <unity_fixture.h>

#include "avr-mate-core/graphx.h"

TEST_GROUP(graphx);

TEST_SETUP(graphx)
{
	graphx_fill(PIXEL_OFF);
}

TEST_TEAR_DOWN(graphx) {}

static void check_pixel(uint8_t x, uint8_t y, uint8_t color)
{
	TEST_ASSERT_EQUAL(color, graphx_get_pixel(x, y));
}

static void check_hline(uint8_t x0, uint8_t x1, uint8_t y, uint8_t color)
{
	for (uint8_t x = x0; x <= x1; ++x) {
		check_pixel(x, y, color);
	}
}

static void check_vline(uint8_t x, uint8_t y0, uint8_t y1, uint8_t color)
{
	for (uint8_t y = y0; y <= y1; ++y) {
		check_pixel(x, y, color);
	}
}

static void check_rect(uint8_t x0, uint8_t x1, uint8_t y0, uint8_t y1,
                       uint8_t color)
{
	check_hline(x0, x1, y0, color);
	check_hline(x0, x1, y1, color);

	check_vline(x0, y0, y1, color);
	check_vline(x1, y0, y1, color);
}

static void check_get_tile(uint8_t x, uint8_t y, uint8_t *tile, uint8_t w,
                           uint8_t h)
{

	uint8_t tmp_tile[h * w / 8];

	// Tile tmp_tile;
	graphx_get_tile(x, y, tmp_tile, w, h);

	for (size_t i = 0; i < sizeof(tmp_tile); ++i) {
		TEST_ASSERT_EQUAL(tile[i], tmp_tile[i]);
	}
}

static void check_fill(uint8_t color)
{
	for (uint8_t x = 0; x < GRAPHX_WIDTH; ++x) {
		for (uint8_t y = 0; y < GRAPHX_HEIGHT; ++y) {
			check_pixel(x, y, color);
		}
	}
}

// #############################################################################

TEST(graphx, test_graphx_draw_pixel)
{
	for (uint8_t x = 0; x < GRAPHX_WIDTH; ++x) {

		for (uint8_t y = 0; y < GRAPHX_HEIGHT; ++y) {

			graphx_draw_pixel(x, y, PIXEL_OFF);
			check_pixel(x, y, PIXEL_OFF);

			graphx_draw_pixel(x, y, PIXEL_ON);
			check_pixel(x, y, PIXEL_ON);

			graphx_draw_pixel(x, y, PIXEL_TOGGLE);
			check_pixel(x, y, PIXEL_OFF);

			graphx_draw_pixel(x, y, PIXEL_TOGGLE);
			check_pixel(x, y, PIXEL_ON);
		}
	}
}

TEST(graphx, test_graphx_draw_hline)
{
	for (uint8_t y = 0; y < GRAPHX_WIDTH; ++y) {

		for (uint8_t x = 0; x < GRAPHX_HEIGHT; ++x) {

			graphx_draw_hline(0, x, y, PIXEL_ON);
			check_hline(0, x, y, PIXEL_ON);

			graphx_draw_hline(0, x, y, PIXEL_OFF);
			check_hline(0, x, y, PIXEL_OFF);
		}
	}
}

TEST(graphx, test_graphx_draw_vline)
{

	for (uint8_t x = 0; x < GRAPHX_WIDTH; ++x) {

		for (uint8_t y = 0; y < GRAPHX_HEIGHT; ++y) {

			graphx_draw_vline(x, 0, y, PIXEL_ON);
			check_vline(x, 0, y, PIXEL_ON);

			graphx_draw_vline(x, 0, y, PIXEL_OFF);
			check_vline(x, 0, y, PIXEL_OFF);
		}
	}
}

TEST(graphx, test_graphx_fill)
{
	graphx_fill(PIXEL_ON);
	check_fill(PIXEL_ON);

	graphx_fill(PIXEL_OFF);
	check_fill(PIXEL_OFF);
}

TEST(graphx, test_graphx_draw_rect)
{
	const uint8_t x0 = 0;
	const uint8_t y0 = 0;

	for (uint8_t y1 = 0; y1 < GRAPHX_HEIGHT; ++y1) {

		for (uint8_t x1 = 0; x1 < GRAPHX_WIDTH; ++x1) {
			graphx_draw_rect(x0, x1, y0, y1, PIXEL_ON);
			check_rect(x0, x1, y0, y1, PIXEL_ON);
			graphx_fill(PIXEL_OFF);
		}
	}
}

TEST(graphx, test_graphx_draw_tile_4x16)
{
	const uint8_t width  = 4;
	const uint8_t height = 16;

	// tile with the shape of a rectangle
	uint8_t tile[] = {0xFF, 0x01, 0x01, 0xFF, /* line 0 */
	                  0xFF, 0x80, 0x80, 0xFF /* line 1 */};

	graphx_draw_tile(0, 0, tile, width, height);

	check_rect(0, width - 1, 0, height - 1, PIXEL_ON);
	check_get_tile(0, 0, tile, width, height);
}

TEST(graphx, test_graphx_draw_tile_1x64)
{
	const uint8_t width  = 1;
	const uint8_t height = 64;

	// tile with the shape of a vertical line
	uint8_t tile[] = {0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};

	graphx_draw_tile(0, 0, tile, width, height);

	check_rect(0, width - 1, 0, height - 1, PIXEL_ON);
	check_get_tile(0, 0, tile, width, height);
}

TEST(graphx, test_graphx_draw_tile_128x8)
{
	const uint8_t width  = 128;
	const uint8_t height = 8;

	// tile with the shape of a horizontal line
	uint8_t tile[] = {
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01};

	graphx_draw_tile(0, 0, tile, width, height);

	check_rect(0, width - 1, 0, 0, PIXEL_ON);
	check_get_tile(0, 0, tile, width, height);
}

TEST(graphx, test_graphx_draw_tile_128x64)
{
	const uint8_t width  = 128;
	const uint8_t height = 64;

	// this tile is basically just a 128x64 rect
	uint8_t tile[] = {
	    0xff, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0xff, 0xff, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0x60, 0x1c, 0x07, 0x07, 0x7c,
	    0xc0, 0x00, 0x00, 0x03, 0x3e, 0xe0, 0x00, 0x00, 0xe0, 0x3e, 0x01,
	    0x00, 0x00, 0xff, 0x41, 0x41, 0x41, 0xc1, 0x22, 0x1c, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff,
	    0x21, 0x21, 0x21, 0x21, 0x52, 0x8c, 0x00, 0x00, 0xf8, 0x06, 0x01,
	    0x01, 0x01, 0x01, 0x06, 0xf8, 0x00, 0x00, 0x03, 0x0c, 0x30, 0xc0,
	    0x30, 0x0c, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20,
	    0x2c, 0x2f, 0x21, 0x21, 0x21, 0x21, 0x21, 0x2f, 0x2c, 0x20, 0x20,
	    0x20, 0x23, 0x2c, 0x2c, 0x23, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x20,
	    0x20, 0x20, 0x21, 0x22, 0x2c, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20,
	    0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x28, 0x28, 0x28, 0x28,
	    0x24, 0x23, 0x20, 0x20, 0x21, 0x26, 0x28, 0x28, 0x28, 0x28, 0x26,
	    0x21, 0x20, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x20, 0x20, 0x20, 0x20,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0x03, 0x03, 0x03,
	    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x83, 0x83, 0x83, 0x03, 0x03,
	    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	    0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03,
	    0x03, 0x03, 0x03, 0x03, 0x03, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x38,
	    0x38, 0x38, 0xff, 0xff, 0xff, 0x38, 0x38, 0x38, 0x38, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0xc0, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0xc0, 0xc0, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x30, 0x78, 0xfc, 0xfc, 0x78, 0x30, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x30, 0x78, 0xfc, 0xfc, 0x78, 0x30, 0x00, 0x00, 0x00,
	    0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x83, 0x83,
	    0x83, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0xbe, 0xaa, 0xb6, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0xbc, 0x96, 0xbc, 0x80, 0x80, 0x80, 0x80, 0x80, 0xff, 0xff, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
	    0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	    0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	    0xff};

	graphx_draw_tile(0, 0, tile, width, height);

	check_hline(0, width - 1, 0, PIXEL_ON);
	check_hline(0, width - 1, height - 1, PIXEL_ON);

	check_vline(0, 0, height - 1, PIXEL_ON);
	check_vline(width - 1, 0, height - 1, PIXEL_ON);

	check_get_tile(0, 0, tile, width, height);
}

TEST_GROUP_RUNNER(graphx)
{
	RUN_TEST_CASE(graphx, test_graphx_draw_pixel);
	RUN_TEST_CASE(graphx, test_graphx_draw_hline);
	RUN_TEST_CASE(graphx, test_graphx_draw_vline);
	RUN_TEST_CASE(graphx, test_graphx_fill);
	RUN_TEST_CASE(graphx, test_graphx_draw_rect);
	RUN_TEST_CASE(graphx, test_graphx_draw_tile_4x16);
	RUN_TEST_CASE(graphx, test_graphx_draw_tile_1x64);
	RUN_TEST_CASE(graphx, test_graphx_draw_tile_128x8);
	RUN_TEST_CASE(graphx, test_graphx_draw_tile_128x64);
}